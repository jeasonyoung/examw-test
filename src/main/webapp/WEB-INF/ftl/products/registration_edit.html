<#--科目设置编辑--> <#include "comm.ftl"/> 
<#assign module="products_registration"/> 
<#assign form="${module}_edit_form"/>
<#assign dg="${module}_softlimit_dg"/>
<script type="text/javascript">
<!--
	$(function() {
		//渠道下拉
		var ch_t = $("#${module}_edit_form input[name='channelId']").combobox({
			url : "<@s.url '/products/channel/combo'/>",
			valueField : "id",
			textField : "name",
			onLoadError : function(e) {
				<@error_dialog "e"/>
			},
			onLoadSuccess : function() {
				var id = "${CURRENT_CHANNEL_ID}";
				if ($.trim(id) == "")
					return;
				ch_t.combobox("setValue", id);
			}
		});
		${module}_chooseProduct = function(){
			var code = "";
			var row = null;
			var d = $("<div/>").dialog({
				title:'选择产品',
				width:800,
				height:600,
				href:"<@s.url '/products/registration/chooseproduct'/>?productId="+$("#${module}_edit_form input[name='productId']").val(),
				modal:true,
				buttons:[
				  {
					text:"保存",
					iconCls:"icon-save",
					handler:function(){
						var ids = products_registration_choose_list_dg_get_value("id");
						if(ids == 0){ 
							$("#${module}_edit_form input[name='productId']").val("");
							$("#${module}_product_name").textbox("clear");
							d.dialog("close");
							return; 
						}
						var names = products_registration_choose_list_dg_get_value("name");
						$("#${module}_edit_form input[name='productId']").val(ids);
						$("#${module}_product_name").textbox("setValue",names);
						d.dialog("close");
					}
				},
				{
					text:"关闭",
					iconCls:"icon-cancel",
					handler:function(){
						d.dialog("close");
					}
				}],
				onClose:function(){
					$(this).dialog("destroy");
				},
				onLoad:function(){
					if(code && !row){
						$("#${module}_edit_form").form("load",{"code":code});
						return;
					}
					if(row) $("#${module}_edit_form").form("load",row);
				}
			});
		}
		var limitData = [];
	var dg=$("#${dg}").datagrid({
		width:470,
		heigth:100,
		fitColumns:true,
		rownumbers:true,
		border:true,
		striped:true,
		idField:"typeId",
		columns:[[{
			field:"typeId",
			checkbox:true
		},{
			title:"软件类型",
			field:"typeName",
			width:20,
			align:"left"
		},{
			title:"绑定次数",
			field:"time",
			width:10,
			align:"center"
		}]],
		toolbar:"#${dg}_toolbar",
		onLoadError:function(e){
			<@error_dialog "e"/>
		},
		onDblClickRow:function(rowIndex,rowData){
			edit_window("编辑类型限制",rowIndex,rowData);
		}
	});
	//add
	${dg}_add = function(){
		edit_window("新增类型限制",0,null);
	};
	${dg}_delete = function(){
		var rows = dg.datagrid("getChecked");
		if(rows && rows.length > 0){
			$.messager.confirm("确认","您是否确认删除选中的数据?",function(r){
				if(!r)return;
				for(var i = 0; i < rows.length; i++){
					var index = dg.datagrid("getRowIndex",rows[i]["typeId"]);
					if(index > -1){
						dg.datagrid("deleteRow",index);
					}
				}
			});
		}else{
			$.messager.alert("提示","未选中须删除的数据！");
		}
		limitData = dg.datagrid("getData");
	};
	function edit_window(title,index,row){
		var d = $("<div/>").dialog({
			title:title,
			width:400,
			height:200,
			href:"<@s.url '/products/registration/typelimit'/>",
			modal:true,
			buttons:[
			{
			    text:"保存",
			    iconCls:"icon-save",
			    handler:function(){
			    	var data = ${module}_get_typelimit();
			    	if(data){
			    		dg.datagrid(row ? "updateRow" : "insertRow",{
							index:index,
							row:data
						});
			    		limitData = dg.datagrid("getRows");
			    		console.info(limitData);
						d.dialog("close");
			    	}
			    }
			},
			{
				text:"关闭",
				iconCls:"icon-cancel",
				handler:function(){
					d.dialog("close");
				}
			}],
			onClose:function(){
				$(this).dialog("destroy");
			},
			onLoad:function(){
				if(row) $("#${module}_typelimit_edit_form").form("load",row);
			}
		});
	}
	var post = {};
	//validate
	${module}_validate = function(){
		var valid = $("#${form}").form("validate");
		if(!valid) return false;
		post["id"] = $("#${form} input[name='id']").val();
		var productId = $("#${form} input[name='productId']").val();
		post["productId"] = [];
		if(productId)
			post["productId"] = productId.split(',');
		post["productName"] = $("#${form} input[name='productName']").val();
		post["limitTime"] = $("#${form} input[name='limitTime']").val();
		post["channelId"] = $("#${form} input[name='channelId']").val();
		post["price"] = $("#${form} input[name='price']").val();
		post["discount"] = $("#${form} input[name='discount']").val();
		post["endTime"] = $("#${form} input[name='endTime']").val();
		return valid;
	}
	${module}_update = function(){
		post["limit"] = [];
		var rows = dg.datagrid("getRows");
		if(rows){
			$.each(rows,function(i,n){
				var opt  = {};
				opt["typeId"] = n["typeId"];
				opt["typeName"] = n["typeName"];
				opt["time"] = n["time"];
				post["limit"].push(opt);
			});
		}
		return post;
	}
	//load
	${module}_load = function(row){
		if(!row)return;
		$("#${form}").form("load",row);
		if(row.limit && $.isArray(row.limit)){
			$.each(row.limit,function(i,n){
				var opt = {};
				opt["typeId"] = n["typeId"];
				opt["typeName"] = n["typeName"]
				opt["time"] = n["time"];
				dg.datagrid("appendRow",opt);
			});
			limitData = row.limit;
		}
	}
	${module}_getLimitDate = function(){
		return limitData;
	}
});
//-->
</script>

<form id="${module}_edit_form" method="POST" style="padding: 10px;">
		<div style="float: left;">
			<label style="width: 75px;">关联产品：</label> 
			<input type="hidden" name="productId"/>
			<input id = "${module}_product_name" name="productName" class="easyui-textbox" data-options="buttonText:'选择 ',prompt:'选择产品',missingMessage:'请选择产品',icons:[{iconCls:'icon-clear',handler:function(e){$(e.data.target).textbox('clear');$('#${module}_edit_form input[name=\'productId\']').val('');}}],width:400,onClickButton:${module}_chooseProduct" />
			<input type="hidden" name="id" />
		</div>
		<div style="float: left; margin-top: 12px;">
			<label style="width: 75px;">期限(月)：</label> 
			<input name="limitTime" class="easyui-numberbox" data-options="editable:true,min:0" style="width: 400px;" />
		</div>
		<div style="float: left; margin-top: 12px;">
			<label style="width: 75px;">渠道：</label> 
			<input name="channelId"	id="${module}_channel_combobox" style="width: 400px;" />
		</div>
		<div style="float: left; margin-top: 12px;">
			<label style="width: 75px;">原价：</label> 
			<input type="text"	name="price" class="easyui-numberbox" data-options="editable:true,min:0,precision:2"	style="width: 400px;" />
		</div>
		<div style="float: left; margin-top: 12px;">
			<label style="width: 75px;">优惠价：</label>
			<input type="text" name="discount" class="easyui-numberbox" data-options="editable:true,min:0,precision:2"	style="width: 400px;" />
		</div>
		<div style="float: left; margin-top: 12px;">
			<label style="width: 75px;">到期时间：</label>
			<input type="text" name="endTime" class="easyui-datebox" data-options="panelWidth:270"	style="width: 400px;" />
		</div>
		<div style="float: left; margin-top: 12px;margin-left:5px">
		<table id="${dg}"></table>
		<div id="${dg}_toolbar">
			<a href="#" class="easyui-linkbutton" onclick="${dg}_add()" data-options="iconCls:'icon-add',plain:true" style="float:left;">新增软件限制</a>
			<span>|</span>
			<a href="#" class="easyui-linkbutton" onclick="${dg}_delete()" data-options="iconCls:'icon-remove',plain:true">删除</a>
		</div>
		</div>
</form>
