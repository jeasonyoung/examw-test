<#--试题（多选）编辑页面-->
<#include "comm.ftl" />
<#assign module = "library_item_${current_item_type_value}" />
<#assign form = "${module}_edit_form" />
<#assign dg = "${module}_opts_dg"/>
<script type="text/javascript">
<!--
$(function(){
	//options list
	var dg = $("#${dg}").datagrid({
		fit:true,
		fitColumns:true,
		rownumbers:true,
		border:true,
		striped:true,
		idField:"opt_id",
		columns:[[{
			field:"opt_id",checkbox:true
		},{
			title:"选项内容", field:"opt_content", width:100,align:"left",
			formatter: function(value,row,index){
				return value.replace(/<[^>]*>/g,"");
			}
		},{
			title:"正确答案",field:"opt",width:10,align:"center",
			formatter: function(value,row,index){
				return "<input type='checkbox' name='answer' value='"+row["opt_id"] +"'/>";
			}
		}]],
		onLoadError:function(e){<@error_dialog "e"/>},
		onDblClickRow:function(rowIndex,rowData){edit_window("编辑选项",rowIndex,rowData);}
	});
	<@shiro.hasPermission name="${PER_UPDATE}">
	//add option
	${dg}_add = function(){edit_window("新增选项",0,null);};
	</@shiro.hasPermission>
	//option edit window
	function edit_window(title,index,row){
		var d = $("<div/>").dialog({
			title:title,width:550,height:200,
			href:"<@s.url '/library/item/edit/option/${current_item_type_value}'/>",
			modal:true,
			buttons:[
			<@shiro.hasPermission name="${PER_UPDATE}">
			{
				text:"保存",iconCls:"icon-save",
				handler:function(){
					var data = $("#${module}_edit_opt_form").form("serialize");
					if($.trim(data["opt_content"]) == ""){
						$.messager.alert("警告","请输入选项内容！");
						return;
					}
					var index = dg.datagrid("getRowIndex",data["opt_id"]);
					if(index > -1) {
						dg.datagrid("updateRow",{index:index, row : data});
					}else{
						dg.datagrid("appendRow",data);
					}
					d.dialog("close");
				}
			},
			</@shiro.hasPermission>
			{
				text:"关闭",iconCls:"icon-cancel",
				handler:function(){ d.dialog("close");}
			}],
			onClose:function(){$(this).dialog("destroy");},
			onLoad:function(){if(row){$("#${module}_edit_opt_form").form("load",row);}}
		});
	};
	<@shiro.hasPermission name="${PER_DELETE}">
	${dg}_delete = function(){
		var rows = dg.datagrid("getChecked");
		if(rows && rows.length > 0){
			$.messager.confirm("确认","您是否确认删除选中的数据?",function(r){
				if(!r)return;
				for(var i = 0; i < rows.length; i++){
					var index = dg.datagrid("getRowIndex",rows[i]["opt_id"]);
					if(index > -1){
						dg.datagrid("deleteRow",index);
					}
				}
			});
		}else{
			$.messager.alert("提示","未选中须删除的数据！");
		}
	};
	</@shiro.hasPermission>
	//============================================================================================
		//load
		${module}_load = function(row){
			if(!row)return;
			$("#${form}").form("load",row);
			if(row.children && $.isArray(row.children)){
				$.each(row.children,function(i,n){
					var opt = {};
					opt["opt_id"] = n["id"];
					opt["opt_content"] = n["content"];
					dg.datagrid("appendRow",opt);
				});
			}
			if(row.answer){
				$.each(row.answer.split(","),function(i,n){
					if($.trim(n) != ""){
						$("#${form} input[name='answer'][value='"+n+"']").attr("checked",true);
					}
				});
			}
		};
		var post = {};
		//validate
		${module}_validate = function(){
			var valid = $("#${form}").form("validate");
			if(!valid) return false;
			post["id"] = $("#${form} input[name='id']").val();
			post["type"] = $("#${form} input[name='type']").val();
			post["typeName"] = $("#${form} input[name='typeName']").val();
			<#if !current_item_child>
			post["examId"] = $("#${form} input[name='examId']").val();
			post["subjectId"] = $("#${form} input[name='subjectId']").val();
			post["sourceId"] = $("#${form} input[name='sourceId']").val();
			post["areaId"] =  $("#${form} input[name='areaId']").val();
			post["year"] = $("#${form} input[name='year']").val();
			post["opt"] = $("#${form} input[name='opt']:checked").val();
			</#if>
			post["content"] = $.trim($("#${form} textarea[name='content']").val());
			if($.trim(post["content"]) == ""){
				$.messager.alert("警告","请输入试题内容！");
				return false;
			}
			var rows = dg.datagrid("getRows");
			if(rows == null || rows.length == 0){
				$.messager.alert("警告","请添加选项！");
				return false;
			}
			$("#${form} input[name='answer']:checked").each(function(i,n){
				if(i == 0){
					post["answer"] = $.trim($(this).val());
				}else{
					post["answer"] += "," + $.trim($(this).val());
				}
			});
			if($.trim(post["answer"]) == ""){
				$.messager.alert("警告","请确定选项中的正确答案！");
				return false;
			}
			post["analysis"] = $.trim($("#${form} textarea[name='analysis']").val());
			if($.trim(post["analysis"]) == ""){
				$.messager.alert("警告","请输入答案解析！");
				return false;
			}
			return valid;
		};
		//update
		${module}_update = function(){
			post["children"] = [];
			var rows = dg.datagrid("getRows");
			if(rows){
				$.each(rows,function(i,n){
					var opt  = {};
					opt["id"] = n["opt_id"];
					opt["content"] = n["opt_content"];
					opt["orderNo"] = i + 1;
					post["children"].push(opt);
				});
			}
			return post;
		};
	//============================================================================================
});
//-->
</script>
<form id="${form}" method="POST" class="easyui-layout" data-options="fit:true,border:false">
	<div data-options="region:'north',collapsible:false,height:210,border:false">
		<div style="float:left;width:100%;display:none;">
			<input name="id" type="hidden" />
			<input name="type" type="hidden" value="${current_item_type_value}" />
			<input name="typeName" type="hidden" value="${current_item_type_name}" />
		</div>
		<#if !current_item_child>
		<div style="float:left;margin-top:5px;width:100%;">
			<label style="width:75px;">所属科目：</label>
			<input name="examId" class="easyui-combotree" data-options="
					url:'<@s.url '/settings/category/exams-tree'/>',
					required:true,lines:true,
					onLoadError:function(e){<@error_dialog 'e'/>},
					onChange:function(n,o){
						$('#${form}_cbb_subjectId').combobox('clear');$('#${form}_cbb_subjectId').combobox('reload','<@s.url '/settings/subject/all'/>?examId=' + n);
						$('#${form}_cbb_areaId').combobox('clear');$('#${form}_cbb_areaId').combobox('reload','<@s.url '/settings/exam/areas'/>?examId=' + n);
					}" style="width:368px;"/>
			<input id="${form}_cbb_subjectId" name="subjectId" class="easyui-combobox" data-options="
					url:'<@s.url '/settings/subject/all'/>?examId=${current_exam_id}',
					required:true,
					valueField:'id',textField:'name',
					onLoadError:function(e){<@error_dialog 'e'/>}
			" style="width:298px;"/>
		</div>
		<div style="float:left;margin-top:2px;width:100%;">
			<label style="margin-top:5px;width:75px;">所属类型：</label>
			<#list PaperTypeMaps?keys as key>
				<label style="padding-top:0px;<#if (key_index > 0)>margin-left:15px;</#if>">
					<input type="radio" name="opt" value="${key}" <#if (key_index == 0)> checked="checked" </#if> />${PaperTypeMaps[key]}
				</label>
			</#list>
		</div>
		<div style="float:left;margin-top:2px;width:100%;">
			<div style="float:left;">
				<label style="width:75px;">试题来源：</label>
				<input name="sourceId" class="easyui-combobox" data-options="
						url:'<@s.url '/library/source/all'/>',
						valueField:'id',textField:'name',
						onLoadError:function(e){ <@error_dialog 'e'/> },
						icons:[{iconCls:'icon-clear',handler:function(e){ $(e.data.target).combobox('clear'); } }]
					" style="width:198px;" />
			</div>
			<div style="float:left;">
				<label style="width:75px;">所属地区：</label>
				<input id="${form}_cbb_areaId" name="areaId" class="easyui-combobox" data-options="
					url:'<@s.url '/settings/exam/areas'/>?examId=${current_exam_id}',
					valueField:'id',textField:'name',
					onLoadError:function(e){<@error_dialog 'e'/> },
					icons:[{iconCls:'icon-clear',handler:function(e){$(e.data.target).combobox('clear');}}]
				" style="width:198px"/>
			</div>
			<div style="float:left;">
				<label style="width:70px;">使用年份：</label>
				<input name="year" type="text" class="easyui-numberbox" data-options="min:0,value:${current_year}" style="width:70px;"/>
			</div>
		</div>
		</#if>
		<div style="float:left;margin-left:10px;margin-top:2px;">
			<textarea style="float:left" name="content" class="easyui-ueditor"  data-options="required:true,width:762,height:<#if current_item_child>120<#else>65</#if>" rows="5" cols="20" />
		</div>
	</div>
	<div data-options="region:'center',title:'选项',tools:[
			<@shiro.hasPermission name='${PER_UPDATE}'>{ iconCls:'icon-add',text:'添加选项', handler:function(){${dg}_add();}},</@shiro.hasPermission>
			<@shiro.hasPermission name='${PER_DELETE}'>{ iconCls:'icon-remove',text:'删除选项', handler:function(){${dg}_delete();}}</@shiro.hasPermission>
			],border:false">
		<table id="${dg}"></table>
	</div>
	<div data-options="region:'south',title:'答案解析',collapsible:false,height:160,border:false">
		<div style="float:left;margin-left:10px;margin-top:2px;">
			<textarea style="float:left" name="analysis" class="easyui-ueditor"  data-options="required:true,width:762,height:70" rows="5" cols="20"/>
		</div>
	</div>
</form>