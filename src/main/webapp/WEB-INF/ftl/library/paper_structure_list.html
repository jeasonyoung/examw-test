<#--试卷结构列表 -->
<#include "comm.ftl"/>
<#assign module="library_paper_structure"/>
<#assign dg="${module}_list_dg"/>
<script type="text/javascript">
<!--
$(function(){
	<@shiro.hasPermission name="${PER_UPDATE}">
	//add structure
	var m = false;
	${module}_add = function(){ 
		if(m)return;
		m = true;
		$.getJSON("<@s.url '/library/paper/structure/order/${current_paper_id}'/>?_=" + Math.random(),function(order){
			m = false;
			${module}_structure_edit_window("新增试卷结构",null,order); 
		});
	};
	</@shiro.hasPermission>
	//edit structure
	${module}_structure_edit_window = function(title,row,order){
		var d = $("<div/>").dialog({
			title:title,width:400,height:300,modal:true,
			href:"<@s.url '/library/paper/structure/edit'/>",
			buttons:[
			<@shiro.hasPermission name="${PER_UPDATE}">
			{
				iconCls:"icon-save",text:"保存",
				handler:function(){
					$.messager.progress();
					$("#${module}_edit_form").form("submit",{
						url:"<@s.url '/library/paper/structure/update/${current_paper_id}'/>",
						onSubmit: function(){
							var isValid = $(this).form("validate");
							if (!isValid)$.messager.progress("close");
							return isValid;
						},
						onLoadError:function(e){ $.messager.progress("close"); <@error_dialog "e"/> },
						success:function(data){
							$.messager.progress("close");
							var data = $.parseJSON(data);
							if(data.success){
								$("#${module}_tree").tree("reload");
								d.dialog("close");
							}else{
								$.messager.show({ title:"保存异常", msg:data.msg });
							}
						}
					});
				}
			},
			</@shiro.hasPermission>
			{
				text:"关闭",iconCls:"icon-cancel",
				handler:function(){ d.dialog("close"); }
			}],
			onClose:function(){ $(this).dialog("destroy"); },
			onLoad:function(){ $("#${module}_edit_form").form("load",row ? row : {"orderNo" : order}); }
		});
	}
	<@shiro.hasPermission name="${PER_DELETE}">
	//delete structure
	${module}_delete = function(){
		var node = $("#${module}_tree").tree("getSelected");
		if(!node){
			$.messager.alert("提示","未选中须删除的数据！");
			return;
		}
		$.messager.confirm("确认","您是否确认删除选中的数据?",function(r){
			if(!r)return;
			$.messager.progress();
			$.ajax({
				url:"<@s.url '/library/paper/structure/delete/${current_paper_id}'/>",
				type:"POST",
				data:{ "structureId":node["id"] },dataType:"json",
				error:function(e){ $.messager.progress("close"); <@error_dialog "e"/> },
				success:function(data,textStatus){
					$.messager.progress("close");
					if(data.success){
						$("#${module}_tree").tree("reload");${dg}_search();
					}else{
						$.messager.show({title:"提示", msg:data.msg });
					}
				}
			});
		});
	};
	</@shiro.hasPermission>
//=========================================================================================
	//items_search
	${dg}_search = function(){
		var structure_id = "";
		var node = $("#${module}_tree").tree("getSelected");
		if(node){structure_id = node["id"];}
		$("#${dg}").datagrid("load",{ "structureId":structure_id, "content":$("#${dg}_toobar input[name='content']").val() });
	};
	<@shiro.hasPermission name="${PER_UPDATE}">
	//items_add
	var show = false;
	${dg}_add = function(obj){
		var structure_id = "",item_type_name = "";
		var node = $("#${module}_tree").tree("getSelected");
		if(!node){
			$.messager.alert("警告"," 请先选择所属［试卷结构］！");
			return;
		}else{
			structure_id = node["id"];item_type_name = node["attributes"]["typeName"];
		}
		//new
		if($(obj).attr("value") == "new"){
			if(show) return;
			show = true;
			$.getJSON("<@s.url '/library/paper/items/order/'/>" + structure_id + "?_=" + Math.random(),function(order){
				show = false;
				${module}_edit_structure_items_window("新增试题["+ item_type_name +"]",0,null, order);
			});
			return;
		}
		//import
		if($(obj).attr("value") == "import"){
			random_import_structure_items(structure_id);
			return;
		}
	};
	//随机导入结构试题
	function random_import_structure_items(structureId){
		$.messager.confirm("试卷结构下导入试题","确认在选中的试卷结构下随机导入试题？",function(r){
			if(r){
				$.messager.progress({ text:"请稍后..." }); 
				$.post("<@s.url '/library/paper/items/random/'/>" + structureId ,function(callback){
					$.messager.progress('close');
					if(callback.success){
						$("#${dg}").datagrid("load");$("#${dg}").datagrid("unselectAll");
					}else{
						$.messager.show({title:"提示", msg:callback.msg });
					}
				},"json");
			}
		});
	}
	</@shiro.hasPermission>
	//edit structure items windows.
	${module}_edit_structure_items_window = function(title,index,row,order){
		var structure_id = "", type = "";
		if(row){
			if(row.structureId)structure_id = row.structureId;
			if(row.type)type = row.type;
		}else{
			var node = $("#${module}_tree").tree("getSelected");
			if(node){ structure_id = node["id"];type = node["attributes"]["type"]; }
		}
		var d = $("<div/>").dialog({
			title:title,width:800,height:600,modal:true,
			href:"<@s.url '/library/paper/items/edit/'/>" + type,
			buttons:[
			<@shiro.hasPermission name="${PER_UPDATE}">
			{
				text:"保存",iconCls:"icon-save",
				handler:function(){
					var valid = eval("library_paper_item_"+type+"_validate()");
					if(!valid) return;
					var post = eval("library_paper_item_"+type+"_update()");
					//alert(post);console.info(post);
					$.ajax({
						url:"<@s.url '/library/paper/items/update/${current_paper_id}'/>/" + structure_id,
						type:"POST",data:JSON.stringify(post),dataType:"json",
						contentType:"application/json;charset=UTF-8",
						error:function(e){ $.messager.progress("close"); <@error_dialog "e"/> },
						success:function(callback,textStatus){
							$.messager.progress("close");
							if(callback.success){
								$("#${dg}").datagrid((row) ? "updateRow" : "insertRow",{index:index, row:callback.data }); 
								d.dialog("close");
							}else{
								$.messager.show({title:"提示", msg:callback.msg });
							}
						}
					});
				}
			},
			</@shiro.hasPermission>
			{
				text:"关闭",iconCls:"icon-cancel",
				handler:function(){ d.dialog("close");}
			}],
			onClose:function(){$(this).dialog("destroy");},
			onLoad:function(){
				if(!row){ row = {"orderNo" : order}; }
				eval("library_paper_item_"+type+"_load(row)");
			}
		});
	};
	<@shiro.hasPermission name="${PER_DELETE}">
	//delete structure items
	${dg}_delete = function(obj){
		var rows = $("#${dg}").datagrid("getChecked");
		if(rows && rows.length > 0){
			$.messager.confirm("确认","您是否确认删除选中数据（"+ $(obj).text()+"）?",function(r){
				if(!r)return;
				$.messager.progress();
				var ids = [];
				for(var i = 0; i < rows.length; i++){
					ids.push(rows[i].structureId + "$" + rows[i].id);
				}
				$.ajax({
					url:"<@s.url '/library/paper/items/delete?isForced='/>" + $(obj).attr("value"),
					type:"POST", data:{ id:ids.join("|") }, dataType:"json",
					error:function(e){ $.messager.progress("close"); <@error_dialog "e"/> },
					success:function(data,textStatus){
						$.messager.progress("close");
						if(data.success){
							$("#${dg}").datagrid("load");$("#${dg}").datagrid("unselectAll");
						}else{
							$.messager.show({title:"提示", msg:data.msg });
						}
					}
				});
			});
		}else{
			$.messager.alert("提示","未选中须删除的数据！");
		}
	};
	</@shiro.hasPermission>
	${module}_paper_item_preview = function(structrureId,itemId){
		var d = $("<div/>").dialog({
			title:"试题预览",width:800,height:600,modal:true,
			href:"<@s.url '/library/paper/items/preview/'/>" +structrureId + '/' +itemId,
			buttons:[{text:"关闭",iconCls:"icon-cancel",handler:function(){ d.dialog("close");}}],
			onClose:function(){$(this).dialog("destroy");}
		});
	};
});
//-->
</script>
<div class="easyui-layout" data-options="fit:true,border:false">
	<div data-options="region:'west',title:'试卷结构',split:true,tools:[{ iconCls:'icon-reload',handler:function(){ $('#${module}_tree').tree('reload'); ${dg}_search();}}
		<@shiro.hasPermission name='${PER_UPDATE}'> ,{ iconCls:'icon-add', handler:function(){ ${module}_add(); } }</@shiro.hasPermission>]" style="width:190px;">
		<ul id="${module}_tree" class="easyui-tree" data-options="url:'<@s.url '/library/paper/structure/all/${current_paper_id}'/>',lines:true,onContextMenu:function(e, node){
			e.preventDefault();$('#${module}_tree_menu').menu('show', {left: e.pageX,top: e.pageY }); },onLoadError:function(e){ <@error_dialog 'e'/> },loadFilter:function(data){
			var o = [];if(data && $.isArray(data)){ $.each(data,function(i,n){ var node = {};node['id'] = n['id'];node['text'] = n['title'];node['attributes'] = n;o.push(node);});	}  return o; },
			onClick:function(node){ ${dg}_search(); }, onDblClick:function(node){ ${module}_structure_edit_window('编辑试卷结构',node.attributes,null); } "></ul>
		<div id="${module}_tree_menu" class="easyui-menu" style="width:120px;">
			<@shiro.hasPermission name="${PER_UPDATE}">
			<div onclick="${module}_add()" data-options="iconCls:'icon-add'">添加试卷结构</div>
			</@shiro.hasPermission>
			<@shiro.hasPermission name="${PER_DELETE}">
			<div onclick="${module}_delete()" data-options="iconCls:'icon-remove'">删除试卷结构</div>
			</@shiro.hasPermission>
		</div>
	</div>
	<div data-options="region:'center'" >
		<table id="${dg}" class="easyui-datagrid" data-options="url:'<@s.url '/library/paper/items/datagrid/${current_paper_id}'/>',fit:true,fitColumns:true,rownumbers:true,border:true,striped:true,
			pagination:true,pagePosition:'bottom',pageSize:20,pageList:[20,30,40],idField:'id',sortName:'orderNo',sortOrder:'desc',toolbar:'#${dg}_toobar',onLoadError:function(e){ <@error_dialog 'e'/> },
			onDblClickRow:function(rowIndex,rowData){
				$.messager.progress({'text':'正在加载数据，请稍后...'}); 
				$.getJSON('<@s.url '/library/paper/items/'/>' + rowData['structureId'] + '/' + rowData['id'] + '?_' + Math.random(),function(callback){
					$.messager.progress('close');
					if(callback['success']){
						${module}_edit_structure_items_window('编辑试题［'+ rowData['typeName'] +'］',rowIndex,callback['data'],null);
					}else{
						$.messager.show({ title:'提示', msg:callback['msg']});
					}
				});
			}">
			<thead>
				<tr>
					<th data-options="field:'id',checkbox:true"></th>
					<th data-options="field:'orderNo',width:10,align:'right',sortable:true">序号</th>
					<th data-options="field:'typeName',width:18,align:'center',sortable:true">题型</th>
					<th data-options="field:'content',width:100,align:'left',formatter:function(value,row,index){ value= value.replace(/<[^>]*>/g,''); return '<span title=\''+value+'\'>'+value+'</span>'; }">试题内容</th>
					<th data-options="field:'preview',width:10,align:'center',formatter:function(value,row,index){ return '<a href=\'#\' onclick=${module}_paper_item_preview(\''+row['structureId']+'\',\'' +row['id']+ '\');>预览</a>';}">预览</th>
				</tr>
			</thead>
		</table>
		<div id="${dg}_toobar">
			<@shiro.hasPermission name="${PER_UPDATE}">
			<a href="#" class="easyui-menubutton" data-options="iconCls:'icon-add',menu:'#${dg}_toobar_menu_add',plain:true" style="float:left;">添加</a>
			<div id="${dg}_toobar_menu_add" style="width:168px;">
				<div onclick="${dg}_add(this)" value="new">新增试题</div>
				<div onclick="${dg}_add(this)" value="import">从题库中随机导入</div>
			</div>
			</@shiro.hasPermission>
			<span>|</span>
			<@shiro.hasPermission name="${PER_DELETE}">
			<a href="#" class="easyui-menubutton" data-options="iconCls:'icon-add',menu:'#${dg}_toobar_menu_remove',plain:true" style="float:left;">删除</a>
			<div id="${dg}_toobar_menu_remove" style="width:128px;">
				<div onclick="${dg}_delete(this)" value="false">仅删除关联</div>
				<div onclick="${dg}_delete(this)" value="true">删除试题</div>
			</div>
			</@shiro.hasPermission>
			<label>题目：<input name="content" type="text" style="width:268px;"/></label>	
			<a href="#" class="easyui-linkbutton" style="margin-left:10px;"  onclick="${dg}_search()" data-options="iconCls:'icon-search',plain:true">查询</a>
		</div>
	</div>
</div>